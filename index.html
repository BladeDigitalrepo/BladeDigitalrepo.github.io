<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hex Run Arcade v15 (Fixed)</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: monospace;
      overflow: hidden;
    }
    canvas {
      display: block;
      margin: auto;
      background: black;
      touch-action: none;
    }
    /* Control Panel */
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      justify-content: space-between;
      gap: 20px;
      width: 90%;
      max-width: 600px;
      z-index: 5;
    }
    .btn {
      background: black;
      border: 2px solid cyan;
      color: cyan;
      font-size: 18px;
      font-family: monospace;
      padding: 15px 25px;
      border-radius: 12px;
      text-align: center;
      user-select: none;
      cursor: pointer;
      box-shadow: 0 0 10px cyan;
    }
    .btn:active { background: cyan; color: black; }
    #btnRestart { display: none; border-color: magenta; color: magenta; box-shadow: 0 0 10px magenta; }
    #btnRestart:active { background: magenta; color: black; }
    #startScreen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: black; color: cyan;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; z-index: 10;
    }
    #startScreen h1 { font-size: 40px; text-shadow: 0 0 20px magenta, 0 0 10px cyan; }
    #btnStart {
      margin-top: 20px; background: black; border: 2px solid magenta; color: magenta;
      padding: 10px 30px; font-size: 20px; font-family: monospace; border-radius: 10px;
      cursor: pointer; box-shadow: 0 0 10px magenta;
    }
    #btnStart:active { background: magenta; color: black; }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="400"></canvas>

  <!-- Start Screen -->
  <div id="startScreen">
    <h1>HEX RUN ARCADE</h1>
    <button id="btnStart">‚ñ∂ START</button>
  </div>

  <!-- Touch Controls -->
  <div id="controls">
    <div class="btn" id="btnLeft">‚¨ÖÔ∏è</div>
    <div class="btn" id="btnJump">‚§¥Ô∏è JUMP</div>
    <div class="btn" id="btnDuck">‚§µÔ∏è DUCK</div>
    <div class="btn" id="btnRight">‚û°Ô∏è</div>
    <div class="btn" id="btnPause">‚è∏Ô∏è</div>
    <div class="btn" id="btnRestart">üîÑ Restart</div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // üîä Sounds
    const jumpSound  = new Audio("sounds/jump.wav");
    const scoreSound = new Audio("sounds/score.wav");
    const crashSound = new Audio("sounds/crash.wav");
    const bgMusic    = new Audio("sounds/bg_loop.mp3");
    bgMusic.loop = true; bgMusic.volume = 0.4;

    function playSound(a) {
      a.currentTime = 0;
      a.play().catch(()=>{});
    }

    // Game state
    let running = false, paused = false;
    let speed = 4;
    let gravity = 0.4;       // lighter pull
    let jumpStrength = -14;  // stronger lift 
    let score = 0;
    let jumpsLeft = 2;

    // Player object
    const player = { x: 100, y: 300, w: 32, h: 32, dy: 0, jumping: false, ducking: false };

    // Load sprite
    const hexImg = new Image();
    hexImg.src = "hex.png";

    function drawHexWithAura() {
      ctx.save();
      ctx.shadowBlur = 19;
      ctx.shadowColor = "#ff59d1";
      ctx.fillStyle = "rgba(255, 89, 209, 0.20)";
      ctx.beginPath();
      ctx.arc(player.x + player.w/2, player.y + player.h/2, 22, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
      // Sprite or ducking
      if (player.ducking) {
        ctx.drawImage(hexImg, player.x, player.y + 10, player.w, player.h / 2);
      } else {
        ctx.drawImage(hexImg, player.x, player.y - 8, player.w, player.h);
      }
    }

    // Obstacles & drones
    const obstacles = [], drones = [];
    let droneCooldown = 0, wallCooldown = 0;

    // Stars
    const stars = [];
    for (let i=0;i<100;i++) stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*2 });

    // Skyline
    const skyline = [];
    function generateSkyline() {
      skyline.length = 0;
      let x = 0;
      while (x < canvas.width + 100) {
        const w = 40 + Math.random()*30;
        const h = 80 + Math.random()*120;
        skyline.push({ x, w, h });
        x += w;
      }
    }
    generateSkyline();

    // Input
    function jump() {
      if (jumpsLeft > 0 && running && !paused && !player.ducking) {
        player.dy = jumpStrength;
        player.jumping = true;
        jumpsLeft--;
        playSound(jumpSound);
      }
    }
    function setDuck(state) {
      if (!running || paused) return;
      if (player.jumping && state) return;
      player.ducking = !!state;
    }

    document.addEventListener("keydown", e=>{
      const k=e.key.toLowerCase();
      if(k==="arrowup") jump();
      if(k==="arrowleft") { if(speed>1) speed--; }
      if(k==="arrowright") { if(speed<20) speed++; }
      if(k==="p") { paused=!paused; if(paused) bgMusic.pause(); else playSound(bgMusic); if(!paused&&running) requestAnimationFrame(gameLoop);}
      if(k==="arrowdown") setDuck(true);
      if(k==="r"&&!running) doRestart();
    });
    document.addEventListener("keyup", e=>{
      const k=e.key.toLowerCase();
      if(k==="arrowdown") setDuck(false);
    });

    // Touch control bindings
    document.getElementById("btnJump").addEventListener("click", jump);
    document.getElementById("btnPause").addEventListener("click", ()=>{
      paused=!paused; if(paused) bgMusic.pause(); else playSound(bgMusic);
      if(!paused&&running) requestAnimationFrame(gameLoop);
    });
    document.getElementById("btnLeft").addEventListener("click", ()=>{ if(speed>1) speed--; });
    document.getElementById("btnRight").addEventListener("click", ()=>{ if(speed<20) speed++; });

    const btnRestart=document.getElementById("btnRestart");
    document.getElementById("btnDuck").addEventListener("mousedown",()=>setDuck(true));
    document.getElementById("btnDuck").addEventListener("mouseup",()=>setDuck(false));
    document.getElementById("btnDuck").addEventListener("mouseleave",()=>setDuck(false));
    document.getElementById("btnDuck").addEventListener("touchstart",e=>{e.preventDefault();setDuck(true);},{passive:false});
    document.getElementById("btnDuck").addEventListener("touchend",e=>{e.preventDefault();setDuck(false);},{passive:false});

    document.getElementById("btnStart").addEventListener("click",()=>{
      document.getElementById("startScreen").style.display="none";
      resetGame(); running=true; playSound(bgMusic); requestAnimationFrame(gameLoop);
    });
    btnRestart.addEventListener("click",()=>doRestart());

    function doRestart(){ resetGame(); btnRestart.style.display="none"; playSound(bgMusic); requestAnimationFrame(gameLoop); }

    function resetGame(){
      obstacles.length=0; drones.length=0; droneCooldown=0; wallCooldown=0; generateSkyline();
      score=0; speed=4; player.y=300; player.dy=0; player.jumping=false; player.ducking=false; jumpsLeft=2;
      running=true; paused=false; btnRestart.style.display="none";
    }

    function update(){
      if(paused) return;
      player.y+=player.dy; player.dy+=gravity;
      if (player.y >= 300) {
        player.y = 300;
        player.dy = 0;
        player.jumping = false;
        jumpsLeft = 2;
      }

      obstacles.forEach(o=>o.x-=speed);
      if(obstacles.length&&obstacles[0].x+20<0){ obstacles.shift(); score++; playSound(scoreSound); }
      drones.forEach(d=>d.x-=speed);
      if(drones.length&&drones[0].x+20<0){ drones.shift(); score++; playSound(scoreSound); }

      const collides=(rx,ry,rw,rh)=>(player.x<rx+rw&&player.x+player.w>rx&&player.y<ry+rh&&player.y+player.h>ry);
      for(const o of obstacles){ if(collides(o.x,o.y,20,40)) gameOver(); }
      for(const d of drones){ if(collides(d.x,d.y,20,20)) gameOver(); }

      if(wallCooldown<=0&&Math.random()<0.02){ obstacles.push({x:canvas.width,y:320}); wallCooldown=120; } else wallCooldown--;
      if(droneCooldown<=0&&Math.random()<0.02){ drones.push({x:canvas.width,y:200+Math.random()*100-50}); droneCooldown=180; } else droneCooldown--;

      skyline.forEach(b=>b.x-=speed*0.5);
      if(skyline.length&&skyline[0].x+skyline[0].w<0){
        const lastX=skyline[skyline.length-1].x+skyline[skyline.length-1].w;
        skyline.shift(); skyline.push({x:lastX,w:40+Math.random()*30,h:80+Math.random()*120});
      }
      if(score%10===0&&score!==0&&speed<12) speed+=0.02;
    }

    function gameOver(){
      if(!running)return;
      running=false; playSound(crashSound); bgMusic.pause(); btnRestart.style.display="block";
    }

    function drawFlame(){
      const flameX=canvas.width/2, flameY=canvas.height/2;
      ctx.save(); ctx.shadowBlur=40; ctx.shadowColor="magenta"; ctx.fillStyle="magenta"; ctx.font="60px monospace"; ctx.textAlign="center"; ctx.globalAlpha=0.15;
      ctx.fillText("üî•", flameX, flameY); ctx.restore();
    }

    function drawSkyline(){
      ctx.shadowBlur=15; ctx.shadowColor="magenta"; ctx.fillStyle="#111";
      skyline.forEach(b=>{ ctx.fillRect(b.x,canvas.height-b.h-60,b.w,b.h); ctx.strokeStyle="magenta"; ctx.strokeRect(b.x,canvas.height-b.h-60,b.w,b.h); });
      ctx.shadowBlur=0;
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle="white";
      stars.forEach(s=>{
        ctx.beginPath();
        ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
        ctx.fill();
        s.x-=0.2; if(s.x<0) s.x=canvas.width;
      });

      drawFlame();
      drawSkyline();

      // Ground
      ctx.fillStyle="lime"; ctx.fillRect(0,340,canvas.width,5);

      // Hex
      drawHexWithAura();

      // Obstacles / drones
      ctx.shadowBlur=10; ctx.shadowColor="red"; ctx.fillStyle="red";
      obstacles.forEach(o=>ctx.fillRect(o.x,o.y,20,40));
      ctx.shadowBlur=0;

      ctx.shadowBlur=10; ctx.shadowColor="orange"; ctx.fillStyle="orange";
      drones.forEach(d=>{ ctx.beginPath(); ctx.arc(d.x+10,d.y+10,10,0,Math.PI*2); ctx.fill(); });
      ctx.shadowBlur=0;

      // Score
      ctx.fillStyle="white"; ctx.font="16px monospace"; ctx.textAlign="left";
      ctx.fillText("Score: "+score,10,20);
      ctx.fillText("Speed: "+speed.toFixed(1),10,40);

      if(!running){
        ctx.fillStyle="white"; ctx.font="24px monospace"; ctx.textAlign="center";
        ctx.fillText("üíÄ GAME OVER üíÄ", canvas.width/2, canvas.height/2);
        ctx.fillText("Final Score: "+score, canvas.width/2, canvas.height/2+40);
      }
      if(paused&&running){
        ctx.fillStyle="white"; ctx.font="20px monospace"; ctx.textAlign="center";
        ctx.fillText("‚è∏ PAUSED",canvas.width/2,canvas.height/2);
      }
    }

    function gameLoop(){
      if(!running){ draw(); return; }
      update(); draw(); requestAnimationFrame(gameLoop);
    }
  </script>
</body>
</html>
